<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TV Show Time Test</title>


  <script src="functions.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">



  </head>

  <body>
    <p id="greeting"></p>
    <h1 id="question"></h1>
    <h1 id="answer"></h1>

    <input type="text" id="show_input" placeholder="Show Name">
    <p></p>
    <div id="output"></div>
  <p></p>
  <p>Display #1: When was this show on the air (over all years). Raw db entries basically</p>
  <p>Display #2: What was also on at the same time on different networks for the same year? (what shows did you lose out on?)</p>
  <p>Display #3: What shows were around the given show? Not sure...</p>

  <a href="sitemap.html">Sitemap</a>
  </body>

    <script>

    var db = [];
    var years = new Set();
    var show_names = new Set();
    var show_names_list = [];
    var networks = new Set();


    // Decode URL arguments and respond to them
    // Just getting away with browser's apis:
    //   * https://developer.mozilla.org/en-US/docs/Web/API/URL, and https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams
    function respondToURL(url) {
      console.log("Before: " + url);
      url = decodeURICustom(url);
      window.history.replaceState({}, '', url);
      console.log("After: " + url);
      const parsedUrl = new URL(url);
      for (let p of parsedUrl.searchParams) {
        console.log(p);
        console.log(p[0] + ' ' + p[1]);
        if (p[0] == "show_name") {
          document.getElementById('show_input').value = p[1];
          searchValidShowName(p[1]);
        }
        if (p[0] == "question") {
          document.getElementById('question').innerText = p[1] + "?";
        }
        if (p[0] == "answer") {
          document.getElementById('answer').innerText = p[1];
        }
      }
      // TODO: Need to handle multiple search params (anded together)
    }

    function loadDB(data) {
      var lines = data.split("\r\n");
      for (var i = 1; i < lines.length; i++) {
        values = lines[i].split("\t");
        years.add(values[0]);
        networks.add(values[1]);
        show_names.add(values[5]);

        db.push(values);
      }
      show_names_list = Array.from(show_names);
    }

    function searchValidShowName(show_name) {
      var output = "";
      for (var i = 0; i < db.length; i++) {
        if (db[i][5] == show_name) {
          output += "<p>" + db[i].join('\t') + "</p>";
        }
      }
      // Update output text area
      document.getElementById('output').innerHTML = output;
    };


    function setupPage(data) {
        loadDB(data);

        respondToURL(window.location.href);


        var allowedChars = new RegExp(/^[a-zA-Z\s]+$/)
        function charsAllowed(value) {
          return allowedChars.test(value);
        }

        autocomplete({
            input: document.getElementById('show_input'),
            minLength: 1,
            onSelect: function(item) {
                show_input.value = item;
                searchValidShowName(item);



                // Rewrite URL
                // TODO: Why doesn't this work inside of searchValidShowName?
                // I think because it's also called by respondToURL?
                var url = "?show_name=" + item;
                window.history.pushState({}, '', encodeURICustom(url));





            },
            fetch: function(text, callback) {
                var match = text.toLowerCase();
                callback(show_names_list.filter(function(n) { return n.toLowerCase().indexOf(match) !== -1; }));
            },
            render: function(item, value) {
                var itemElement = document.createElement("div");
                if (charsAllowed(value)) {
                  var regex = new RegExp(value, 'gi');
                  var inner = item.replace(regex, function(match) { return "<strong>" + match + "</strong>" });
                  itemElement.innerHTML = inner;
                } else {
                  itemElement.textContent = item;
                }
                return itemElement;
              },

        });
    }


    fetch('https://nolanhergert.github.io/TVScheduleHistory/TV%20Schedule%20Test%20-%20DB%20Way.tsv')
    .then(response => response.text())
    .then(text => setupPage(text))

    // Detect if URL changed while page was already loaded (back/forward buttons)
    window.addEventListener('popstate', function (event) {
      respondToURL(window.location.href);
    });
    </script>

  <!--https://github.com/kraaden/autocomplete-->
  <script defer src="autocomplete.js"></script>
  <link defer rel="stylesheet" type="text/css" href="autocomplete.css">

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script defer src="https://www.googletagmanager.com/gtag/js?id=G-5YLR3L284J"></script>
  <script defer src="google_analytics.js"></script>
</html>